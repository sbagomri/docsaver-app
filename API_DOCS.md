# üìö DocSaver API Documentation

## Database Layer (Drift)

### AppDatabase Class

Main database class providing access to all tables and operations.

#### Core Methods

##### Documents

```dart
// Get all documents
Future<List<Document>> getAllDocuments()

// Get documents by category
Future<List<Document>> getDocumentsByCategory(String category)

// Get favorite documents
Future<List<Document>> getFavoriteDocuments()

// Get recent documents
Future<List<Document>> getRecentDocuments({int limit = 10})

// Search documents
Future<List<Document>> searchDocuments(String query)

// Get document by ID
Future<Document?> getDocumentById(int id)

// Create document
Future<int> createDocument(DocumentsCompanion document)

// Update document
Future<bool> updateDocument(Document document)

// Delete document
Future<int> deleteDocument(int id)

// Get document count by category
Future<int> getDocumentCountByCategory(String category)

// Get total storage used
Future<int> getTotalStorageUsed()
```

##### Categories

```dart
// Get all categories
Future<List<Category>> getAllCategories()
```

##### Reminders

```dart
// Get reminders for document
Future<List<Reminder>> getRemindersForDocument(int documentId)

// Get upcoming reminders
Future<List<Reminder>> getUpcomingReminders()
```

##### Extracted Data

```dart
// Get extracted data for document
Future<List<ExtractedDatum>> getExtractedDataForDocument(int documentId)
```

##### Notes

```dart
// Get notes for document
Future<List<UserNote>> getNotesForDocument(int documentId)
```

---

## Providers (Riverpod)

### Database Providers

```dart
// Database instance
final databaseProvider = Provider<AppDatabase>

// All documents
final documentsProvider = FutureProvider<List<Document>>

// Recent documents
final recentDocumentsProvider = FutureProvider<List<Document>>

// Favorite documents
final favoriteDocumentsProvider = FutureProvider<List<Document>>

// All categories
final categoriesProvider = FutureProvider<List<Category>>

// Upcoming reminders
final upcomingRemindersProvider = FutureProvider<List<Reminder>>

// Document count by category
final documentCountProvider = FutureProvider.family<int, String>

// Total storage used
final totalStorageProvider = FutureProvider<int>
```

### Usage Examples

```dart
// In a ConsumerWidget
class MyWidget extends ConsumerWidget {
  @override
  Widget build(BuildContext context, WidgetRef ref) {
    final documentsAsync = ref.watch(documentsProvider);
    
    return documentsAsync.when(
      data: (documents) => ListView.builder(
        itemCount: documents.length,
        itemBuilder: (context, index) => DocumentCard(documents[index]),
      ),
      loading: () => CircularProgressIndicator(),
      error: (err, stack) => Text('Error: $err'),
    );
  }
}
```

---

## Domain Entities

### DocumentEntity

Represents a document in the domain layer.

```dart
class DocumentEntity {
  final int? id;
  final String title;
  final String category;
  final String filePath;
  final String? thumbnailPath;
  final int fileSizeBytes;
  final String mimeType;
  final DateTime createdAt;
  final DateTime modifiedAt;
  final List<String> tags;
  final bool isFavorite;
  final String? extractedText;
  final bool isOcrProcessed;
  final String? cloudStorageUrl;
  final bool isSynced;
  final DateTime? lastSyncedAt;
  
  // Helper methods
  String get formattedSize;
  bool get hasExpired;
}
```

### CategoryEntity

```dart
class CategoryEntity {
  final int? id;
  final String name;
  final String icon;
  final int sortOrder;
  final bool isSystem;
  final DateTime createdAt;
}
```

### ReminderEntity

```dart
class ReminderEntity {
  final int? id;
  final int documentId;
  final String title;
  final String? description;
  final DateTime reminderDate;
  final bool isAutoGenerated;
  final bool isCompleted;
  final int? notificationId;
  final DateTime createdAt;
  
  // Helper methods
  bool get isPending;
  bool get isOverdue;
}
```

### ExtractedDataEntity

```dart
class ExtractedDataEntity {
  final int? id;
  final int documentId;
  final String dataType;
  final String value;
  final DateTime? dateValue;
  final double confidence;
  final DateTime extractedAt;
  
  // Helper methods
  bool get isHighConfidence;
  bool get isDateType;
}
```

---

## Error Handling

### Result Type

Generic result type for operations that can fail.

```dart
class Result<T> {
  final T? data;
  final AppException? error;
  
  bool get isSuccess;
  bool get isFailure;
  
  // Transform data
  Result<R> map<R>(R Function(T data) transform);
  
  // Callbacks
  void onSuccess(void Function(T data) callback);
  void onFailure(void Function(AppException error) callback);
  
  // Get data
  T getOrThrow();
  T getOrDefault(T defaultValue);
}
```

### Exception Types

```dart
// Base exception
abstract class AppException implements Exception {
  final String message;
  final String? code;
  final dynamic originalError;
}

// Specific exceptions
class DatabaseException extends AppException
class FileSystemException extends AppException
class EncryptionException extends AppException
class AuthenticationException extends AppException
class OCRException extends AppException
class SyncException extends AppException
class ValidationException extends AppException
```

### Usage Example

```dart
Future<Result<Document>> createDocument() async {
  try {
    final doc = await database.createDocument(...);
    return Result.success(doc);
  } on DatabaseException catch (e) {
    return Result.failure(e);
  } catch (e) {
    return Result.failure(
      AppException('Unexpected error: $e', originalError: e)
    );
  }
}

// Using the result
final result = await createDocument();
result.onSuccess((doc) => print('Created: ${doc.title}'));
result.onFailure((err) => showError(err.message));
```

---

## Constants

### AppConstants

```dart
class AppConstants {
  // App Info
  static const String appName = 'DocSaver';
  static const String appTagline = 'Your Digital Vault';
  
  // Database
  static const String databaseName = 'docsaver.db';
  static const String dbEncryptionKeyName = 'db_encryption_key';
  
  // Secure Storage Keys
  static const String userPinKey = 'user_pin_hash';
  static const String biometricsEnabledKey = 'biometrics_enabled';
  static const String syncEncryptionKeyPrefix = 'file_key_';
  
  // File Limits
  static const int maxFileSizeMB = 50;
  static const int maxImageWidth = 1920;
  static const int imageQuality = 85;
  
  // OCR
  static const int ocrRetryAttempts = 3;
  static const Duration ocrTimeout = Duration(seconds: 30);
  
  // Default Categories
  static const List<Map<String, dynamic>> defaultCategories = [
    // ... see constants file
  ];
}
```

---

## Theme System

### Colors

```dart
class AppColors {
  // Dark Theme
  static const darkBackground = Color(0xFF0A0E21);
  static const darkSurface = Color(0xFF1D1F33);
  static const darkCard = Color(0xFF2B2D42);
  static const accent = Color(0xFF6C63FF);
  static const accentLight = Color(0xFF8B84FF);
  static const textPrimary = Color(0xFFEEEEEE);
  static const textSecondary = Color(0xFFB0B3C1);
  static const success = Color(0xFF4ECDC4);
  static const warning = Color(0xFFFFB84D);
  static const error = Color(0xFFFF6B6B);
  
  // Light Theme
  static const lightBackground = Color(0xFFF8F9FA);
  static const lightSurface = Color(0xFFFFFFFF);
  // ... more colors
}
```

### Typography

```dart
class AppTypography {
  static const h1 = TextStyle(
    fontSize: 32,
    fontWeight: FontWeight.w700,
    letterSpacing: -0.5,
  );
  
  static const h2 = TextStyle(
    fontSize: 24,
    fontWeight: FontWeight.w600,
    letterSpacing: -0.3,
  );
  
  static const body = TextStyle(
    fontSize: 16,
    fontWeight: FontWeight.w400,
    height: 1.5,
  );
  
  // ... more styles
}
```

### Spacing (8pt Grid)

```dart
class AppSpacing {
  static const double xs = 4.0;
  static const double sm = 8.0;
  static const double md = 16.0;
  static const double lg = 24.0;
  static const double xl = 32.0;
  static const double xxl = 48.0;
}
```

---

## Navigation

### Routes (go_router)

*Coming soon - will be implemented in Phase 1*

```dart
final router = GoRouter(
  routes: [
    GoRoute(path: '/', builder: (context, state) => HomeScreen()),
    GoRoute(path: '/document/:id', builder: (context, state) => DocumentDetailScreen()),
    GoRoute(path: '/category/:name', builder: (context, state) => CategoryScreen()),
    // ... more routes
  ],
);
```

---

## Testing

### Unit Testing Example

```dart
void main() {
  group('DocumentEntity', () {
    test('formattedSize returns correct format for bytes', () {
      final doc = DocumentEntity(
        title: 'Test',
        category: 'Test',
        filePath: '/test',
        fileSizeBytes: 500,
        mimeType: 'application/pdf',
        createdAt: DateTime.now(),
        modifiedAt: DateTime.now(),
      );
      
      expect(doc.formattedSize, '500 B');
    });
    
    test('formattedSize returns correct format for KB', () {
      final doc = DocumentEntity(
        // ...
        fileSizeBytes: 2048,
      );
      
      expect(doc.formattedSize, '2.00 KB');
    });
  });
}
```

### Widget Testing Example

```dart
void main() {
  testWidgets('HomeScreen displays app name', (tester) async {
    await tester.pumpWidget(
      ProviderScope(
        child: MaterialApp(home: HomeScreen()),
      ),
    );
    
    expect(find.text('DocSaver'), findsOneWidget);
  });
}
```

---

## Best Practices

### 1. Always use Result type for operations that can fail

```dart
// Good ‚úÖ
Future<Result<Document>> createDocument() async { ... }

// Avoid ‚ùå
Future<Document> createDocument() async { ... }
```

### 2. Use Riverpod providers for state management

```dart
// Good ‚úÖ
final documentsProvider = FutureProvider<List<Document>>((ref) async {
  final db = ref.watch(databaseProvider);
  return db.getAllDocuments();
});

// Avoid ‚ùå
class DocumentsNotifier extends ChangeNotifier { ... }
```

### 3. Follow Clean Architecture layers

```
Domain (Entities, Use Cases) ‚Üí Data (Repositories, Data Sources) ‚Üí Presentation (UI, Providers)
```

### 4. Use constants instead of magic strings/numbers

```dart
// Good ‚úÖ
duration: AppConstants.ocrTimeout

// Avoid ‚ùå
duration: Duration(seconds: 30)
```

---

## Code Style

Follow the official [Dart Style Guide](https://dart.dev/guides/language/effective-dart/style).

Key points:
- Use `camelCase` for variables and functions
- Use `PascalCase` for classes
- Use `snake_case` for file names
- Prefer `final` over `var` when possible
- Always specify types for public APIs
- Document public APIs with `///` comments

---

**For more examples, see the source code in the repository.**

